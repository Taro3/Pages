# 画像ビューアの構築

コンピュータビジョンは、デジタル画像や映像をバイトやピクセルとして扱うだけでなく、コンピュータが高度に理解することを可能にする技術である。シーン再構成、イベント検出、ビデオトラッキング、物体認識、3D姿勢推定、モーション推定、画像復元などに広く利用されている。

OpenCV（オープンソースコンピュータビジョン）は、ほぼすべてのコンピュータビジョンの手法とアルゴリズムを実装したライブラリです。 Qt は、すべての主要なデスクトッププラットフォーム、ほとんどの組み込みプラットフォーム、さらにモバイルプラットフォームで動作するグラフィカルユーザーインターフェースを備えたアプリケーションを作成するための、クロスプラットフォームアプリケーションフレームワークとウィジェットツールキットです。

この2つの強力なライブラリは、コンピュータビジョン技術の恩恵を受ける産業において、強固なGUIを持つプロフェッショナルなソフトウェアを作成するために、多くの開発者によって共に使用されています。本書では、親しみやすいGUIとコンピュータビジョン技術に関連するいくつかの機能を持つQt 5とOpenCV 4を用いて、この種の機能的なアプリケーションを構築する方法を紹介します。

この第1章では、まずQt 5を使って画像閲覧用の簡単なGUIアプリケーションを構築します。

本章では、以下のようなトピックを以下のように取り上げます。

* ユーザインタフェースの設計
* Qt による画像の読み込みと表示
* 画像のズームイン・ズームアウト
* 画像のコピーを任意のフォーマットで保存する
* Qt アプリケーションでホットキーに対応する

***

## 技術的要件
少なくとも Qt バージョン 5 がインストールされており、C++ および Qt プログラミングの基本的な知識があることを確認してください。また、互換性のあるC++コンパイラー（LinuxではGCC 5以降、macOSではClang 7.0以降、Microsoft WindowsではMSVC 2015以降）が必要です。

前提条件として適切な基礎知識が必要なため、Qtのインストールとコンパイラ環境のセットアップは本書には含まれていません。これらの基本的な設定方法については、多くの書籍やオンラインドキュメント、チュートリアル（例えば、Lee Zhi Eng著「GUI Programming with C++ and Qt5」や、Qtライブラリの公式ドキュメント）がありますので、必要に応じてご自身で参照してください。

これらの前提条件をすべて満たした上で、最初のアプリケーションであるシンプルな画像ビューアーの開発を始めましょう。

この章のすべてのコードは、私たちのコードリポジトリ(https://github.com/PacktPublishing/Qt-5-and-OpenCV-4-Computer-Vision-Projects/tree/master/Chapter-01)にあります。

次のビデオで、コードが実際に動いているところをご覧ください： http://bit.ly/2KoYWFx

***

## ユーザーインターフェースの設計
アプリケーションを構築する最初の部分は、そのアプリケーションが何をするのかを定義することです。この章では、画像ビューアーのアプリを開発します。そのために必要な機能は、次のとおりです。

* ハードディスクから画像を開く
* ズームイン/ズームアウト
* 同じフォルダー内の前後の画像を見ることができる
* 現在の画像のコピーを、別のファイル（パスやファイル名が異なる）として、別のフォーマットで保存する。

LinuxのgThumbやmacOSのPreview appなど、多くの画像ビューアアプリケーションがあります。しかし、今回のアプリケーションは、事前準備を行ったという点で、それらよりもシンプルになります。そのために、Pencilを使って、アプリケーションのプロトタイプのワイヤーフレームを描きました。https://pencil.evolus.vn/

以下は、アプリケーションのプロトタイプを示すワイヤーフレームです。

![ワイヤーフレーム](img/251333cc-d29d-4708-aaba-717b82b2af4d.png)

先ほどの図にあるように、メインウィンドウには **「メニューバー」「ツールバー」「メインエリア」「ステータスバー」** の4つのエリアが用意されています。

メニューバーには、 **「ファイル」** メニューと **「表示」** メニューの2つのメニューオプションがあります。それぞれのメニューには、独自のアクションが用意されています。ファイルメニューは、以下の3つのアクションで構成されています。

* **開く**：このオプションは、ハードディスクから画像を開きます。
* **名前を付けて保存**： このオプションは、現在の画像のコピーを、サポートされている任意の形式の別のファイル（異なるパスまたはファイル名）として保存します。
* **終了**： このオプションは、アプリケーションを終了します。

**「表示」** メニューは、以下の4つのアクションで構成されています。

* **ズームイン**： このオプションは、画像を拡大します。
* **ズームアウト**： このオプションは、画像をズームアウトします。
* **前**：このオプションは、現在のフォルダー内の前の画像を開きます。
* **次**： このオプションは、現在のフォルダー内の次のイメージを開きます。

ツールバーは、メニューオプションにもあるいくつかのボタンで構成されています。これらのボタンをツールバーに配置したのは、これらのアクションを実行するためのショートカットをユーザーに提供するためです。そのため、以下を含め、頻繁に使用するアクションをすべて含める必要があります。

* 開く
* ズームイン
* ズームアウト
* 前の画像
* 次の画像

メインエリアは、アプリケーションで開いている画像を表示するために使用されます。

ステータス・バーは、表示中の画像に関する情報（パス、サイズ、バイト単位サイズ）を表示するために使用されます。

このデザインのソースファイルは、GitHubのコードレポジトリ(https://github.com/PacktPublishing/Qt-5-and-OpenCV-4-Computer-Vision-Projects)で見ることができます。このファイルは、リポジトリのルートディレクトリに WireFrames.epgz という名前で存在するだけです。このファイルは、Pencilアプリケーションで開く必要があります。

***

## プロジェクトをゼロから始める
このセクションでは、画像ビューアーアプリケーションをゼロから構築します。統合開発環境（IDE）やエディターを使用することは想定していません。ここでは、コード自体に注目し、ターミナルで qmake を使用してアプリケーションをビルドする方法について説明します。

まず、ImageViewerという名前で、プロジェクト用の新しいディレクトリを作成しましょう。私はLinuxを使用しているので、以下のようにTerminalで実行します。

```sh
$ pwd
/home/kdr2/Work/Books/Qt5-And-OpenCV4-Computer-Vision-Projects/Chapter-01
$ mkdir ImageViewer
$
```

次に、そのディレクトリにmain.cppという名前のC++のソースファイルを以下の内容で作成します。

```cpp
    #include <QApplication>
    #include <QMainWindow> です。

    int main(int argc, char *argv[])
    {
        QApplication app(argc, argv);
        QMainWindowのwindow.SetWindowTitleを設定します。
        window.setWindowTitle("ImageViewer")。
        window.show()を実行します。
        return app.exec()。
    }
```

このファイルは、アプリケーションの入り口となるものです。このファイルでは、まずQtライブラリが提供するGUIベースのQtアプリケーション専用のヘッダファイルをインクルードします。次に、多くのC++アプリケーションと同様に、main関数を定義します。main関数では、画像閲覧アプリケーションの実行中を表すQApplicationクラスのインスタンスと、前節で設計したメインUIウィンドウとなるQMainWindowのインスタンスを定義しています。QMainWindowのインスタンスを生成した後、そのメソッドをいくつか呼びます：setWindowTitleでウィンドウのタイトルを設定し、showでウィンドウを出現させます。最後に、アプリケーションインスタンスのexecメソッドを呼び出し、Qtアプリケーションのメインイベントループに入ります。これにより、アプリケーションはexit()が呼ばれるまで待機し、exit()に設定された値を返すようになります。

main.cppファイルがプロジェクトディレクトリに保存されたら、ターミナルでそのディレクトリに入り、qmake -projectを実行して、以下のようにQtのプロジェクトファイルを生成します。

```sh
    $ cd ImageViewer/
    $ ls
    main.cpp
    $ qmake -project
    $ ls
    ImageViewer.pro main.cpp
    $
```

このように、ImageViewer.proというファイルが生成されます。このファイルには、Qtプロジェクトの多くのディレクティブや設定が含まれており、qmakeはこのImageViewer.proファイルを使って、後でmakefileを生成します。そのプロジェクトファイルを調べてみましょう。その内容は、以下のように#で始まるコメント行をすべて省略した後、以下のスニペットに記載されています。

```qmake
    TEMPLATE = app
    TARGET = ImageViewer
    includeepath += .

    defines += qt_deprecated_warnings

    SOURCES += main.cpp
```

これを一行ずつ見ていきましょう。

最初の行、TEMPLATE = appは、プロジェクトを生成するときに使用するテンプレートとしてappを指定しています。ここには、例えばlibやsubdirsなど、他の多くの値を指定することができます。私たちは、直接実行できるアプリケーションを構築しているので、appという値が適切です。他の値を使用することは、この章の範囲外です。http://doc.qt.io/qt-5/qmake-manual.html 自分でqmakeのマニュアルを参照して調べてみてください。

2行目のTARGET = ImageViewerは、アプリケーションの実行ファイル名を指定しています。つまり、プロジェクトがビルドされると、ImageViewerという名前の実行ファイルが生成されます。

残りの行では、インクルードパス、マクロ定義、入力ソースファイルなど、コンパイラのオプションをいくつか定義しています。どの行が何を行うかは、これらの行の変数名から簡単に確認することができます。

では、プロジェクトをビルドし、qmake -makefile を実行して makefile を生成し、make を実行してプロジェクトをビルド、つまりソースをコンパイルして目的の実行ファイルを生成してみましょう。

```sh
    $ qmake -makefile
    $ ls
    ImageViewer.pro main.cpp Makefile
    $ make
    g++ -c -pipe -O2 -Wall -W -D_REENTRANT -fPIC -DQT_DEPRECATED_WARNINGS -DQT_NO_DEBUG -DQT_GUI_LIB -DQT_CORE_LIB -I. -I. -isystem /usr/include/x86_64-linux-gnu/qt5 -isystem /usr/include/x86_64-linux-gnu/qt5/QtGui -isystem /usr/include/x86_64-linux-gnu/qt5/QtCore -I. -isystem /usr/include/libdrm -I/usr/lib/x86_64-linux-gnu/qt5/mkspecs/linux-g++
    -o main.o main.cpp
    main.cpp:1:10: fatal error: QApplication: No such file or directory
     #include <QApplication>
              ^~~~~~~~~~~~~~
    compilation terminated.
    make: *** [Makefile:395: main.o] Error 1
    $
```

おっと！？大きなエラーが出ました。これは、Qtバージョン5から、すべてのネイティブGUI機能がコアモジュールからウィジェットモジュールという別のモジュールに移動したためです。私たちのアプリケーションがそのモジュールに依存していることをqmakeに伝えるために、 greaterThan(QT_MAJOR_VERSION, 4)という行を追加する必要があります。QT += widgets をプロジェクトファイルに追加してください．この修正により、ImageViewer.proの中身は以下のようになります。

```qmake
    TEMPLATE = app
    TARGET = ImageViewer
    greaterThan(QT_MAJOR_VERSION, 4): QT += widgets

    INCLUDEPATH += .

    DEFINES += QT_DEPRECATED_WARNINGS

    SOURCES += main.cpp
```

それでは、Terminalでqmake -makefileとmakeコマンドを発行して、以下のようにアプリケーションを再度ビルドしてみましょう。

```sh
    $ qmake -makefile
    $ make
    g++ -c -pipe -O2 -Wall -W -D_REENTRANT -fPIC -DQT_DEPRECATED_WARNINGS -DQT_NO_DEBUG -DQT_WIDGETS_LIB -DQT_GUI_LIB -DQT_CORE_LIB -I.D. -DQT_CORE_LIB -I. -I. -isystem /usr/include/x86_64-linux-gnu/qt5 -isystem /usr/include/x86_64-linux-gnu/qt5/QtWidgets -isystem /usr/include/x86_64-linux-gnu/qt5/QtGui -isystem /usr/include/x86_64-linux-gnu/qt5/QtCore -I. -isystem /usr/include/libdrm -I/usr/lib/x86_64-linux-gnu/qt5/mkspecs/linux-g++ -o main.o main.cpp
    g++ -Wl,-O1 -o ImageViewer main.o -lQt5Widgets -lQt5Gui -lQt5Core -lGL -lpthread
    $ ls
   ImageViewer ImageViewer.pro main.cpp main.o Makefile
    $
```

やったー! これでようやく、プロジェクトディレクトリに実行ファイルImageViewerができました。では、実行し、ウィンドウがどのように見えるか見てみましょう。

![実行イメージ](img/bc8f3961-2404-413c-a509-21248663fe49.png)

見ての通り、これはただの空白のウィンドウです。次の「ユーザーインターフェースの設定」で、設計したワイヤーフレームに従って、ユーザーインターフェース全体を実装していきます。

ここでは、IDEやエディタには触れず、アプリケーションをターミナル上でqmakeでビルドしましたが、使い慣れたIDE、例えば、Qt Creatorでもかまいません。特にWindowsでは、ターミナル（cmdやMinGW）はLinuxやmacOSのTerminalほど性能が良くないので、気軽にIDEを使用してください。

***

